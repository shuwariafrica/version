name: "Integration Build"

on:
  workflow_dispatch:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
    tags: [ v* ]

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  JDK_RELEASE: 17
  JDK_CURRENT: 25
  NODE_LTS: 22
  SBT_OPTS: >- # Use all available resources
    -Xmx10G
    -Xms6G
    -Xss8M
    -XX:ReservedCodeCacheSize=512M

jobs:
  test_jvm:
    name: Execute Tests (JVM) (JDK ${{ matrix.java }})
    strategy:
      fail-fast: false
      matrix:
        java: [ 17, 21, 25 ]
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Java ${{ matrix.java }}
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: ${{ matrix.java }}
          check-latest: true

      - name: Set up sbt
        uses: sbt/setup-sbt@v1

      - name: Set up Coursier cache
        uses: coursier/cache-action@v7

      - name: Execute Unit Tests
        run: sbt --no-colors --supershell=false "version-jvm/test"

      - name: Package Project Products
        run: sbt --no-colors --supershell=false "version-jvm/package"

  test_native:
    name: Execute Tests (Native ${{ matrix.os }})
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-24.04, windows-2025, macos-26 ]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Java ${{ env.JDK_CURRENT }}
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: ${{ env.JDK_CURRENT }}
          check-latest: true
          cache: sbt

      - name: Set up sbt
        uses: sbt/setup-sbt@v1

      - name: Set up Coursier cache
        uses: coursier/cache-action@v7

      # Scala Native toolchains per OS
      - name: Install LLVM/Clang toolchain (Ubuntu)
        if: startsWith(matrix.os, 'ubuntu')
        shell: bash
        run: |
          sudo apt-get update -y
          sudo apt-get install -y clang lld llvm libuv1-dev

      - name: Install LLVM toolchain (macOS)
        if: startsWith(matrix.os, 'macos')
        shell: bash
        run: |
          brew update
          brew install llvm libuv || true
          echo "$(brew --prefix llvm)/bin" >> "$GITHUB_PATH"

      - name: Install LLVM toolchain (Windows)
        if: startsWith(matrix.os, 'windows')
        shell: pwsh
        run: |
          choco install -y llvm
          vcpkg install libuv:x64-windows
          echo "C:\Program Files\LLVM\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "$env:VCPKG_INSTALLATION_ROOT\installed\x64-windows\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "LIBRARY_PATH=$env:VCPKG_INSTALLATION_ROOT\installed\x64-windows\lib" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "C_INCLUDE_PATH=$env:VCPKG_INSTALLATION_ROOT\installed\x64-windows\include" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Execute Unit Tests
        run: sbt --no-colors --supershell=false "version-native/test"

      - name: Package Project Products
        run: sbt --no-colors --supershell=false "version-native/package"

  test_js:
    name: Execute Tests (NodeJS ${{ matrix.node }})
    strategy:
      fail-fast: false
      matrix:
        node: [ 22.x, 24.x ]
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js environment
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node }}
          check-latest: true

      - name: Setup Java ${{ env.JDK_CURRENT }}
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: ${{ env.JDK_CURRENT }}
          check-latest: true
          cache: sbt

      - name: Set up sbt
        uses: sbt/setup-sbt@v1

      - name: Set up Coursier cache
        uses: coursier/cache-action@v7

      - name: Execute Unit Tests
        run: sbt --no-colors --supershell=false "version-js/test"

      - name: Package Project Products
        run: sbt --no-colors --supershell=false "version-js/package"

  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-24.04
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Java ${{ env.JDK_CURRENT }}
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: ${{ env.JDK_CURRENT }}
          check-latest: true
          cache: sbt

      - name: Set up sbt
        uses: sbt/setup-sbt@v1

      - name: Set up Coursier cache
        uses: coursier/cache-action@v7

      - name: Verify Source Formatting
        id: scalafmt
        continue-on-error: true
        run: sbt --no-colors --supershell=false scalafmtCheckAll

      - name: Verify Linting Conformity
        id: scalafix
        continue-on-error: true
        run: sbt --no-colors --supershell=false "scalafixAll --check"

      - name: Verify File Header Conformity
        id: headers
        continue-on-error: true
        run: sbt --no-colors --supershell=false headerCheckAll

      - name: Check for failures
        if: always()
        run: |
          failed=""
          [[ "${{ steps.scalafmt.outcome }}" == "failure" ]] && failed="$failed scalafmtCheckAll"
          [[ "${{ steps.scalafix.outcome }}" == "failure" ]] && failed="$failed scalafixAll"
          [[ "${{ steps.headers.outcome }}" == "failure" ]] && failed="$failed headerCheckAll"
          if [[ -n "$failed" ]]; then
            echo "::error::Static analysis checks failed:$failed"
            exit 1
          fi


  publish:
    name: Publish Release
    needs: [ test_jvm, test_native, test_js, static-analysis ]
    if: github.event_name != 'pull_request' && startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: ${{ env.JDK_RELEASE }}
          check-latest: true

      - name: Set up sbt
        uses: sbt/setup-sbt@v1

      - name: Set up Coursier cache
        uses: coursier/cache-action@v7

      - name: Import Signing Key
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.OSS_PUBLISH_USER_SIGNING_KEY }}
          git_user_signingkey: true
          git_commit_gpgsign: true
          trust_level: 5

      - name: Publish Projects
        run: sbt --no-colors --supershell=false publishSigned sonaUpload sonaRelease
        env:
          SONATYPE_USERNAME: ${{ secrets.OSS_PUBLISH_USER }}
          SONATYPE_PASSWORD: ${{ secrets.OSS_PUBLISH_USER_PASSPHRASE }}
          SIGNING_KEY_ID: ${{ secrets.OSS_PUBLISH_USER_SIGNING_KEY_ID }}
