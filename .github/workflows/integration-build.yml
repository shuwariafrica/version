name: "Integration Build"

on:
  workflow_dispatch:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
    tags: [ v* ]

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  JDK_RELEASE: 17
  JDK_CURRENT: 25
  NODE_LTS: 22
  SBT_OPTS: >- # Use all available resources
    -Xmx10G
    -Xms6G
    -Xss8M
    -XX:ReservedCodeCacheSize=512M

jobs:
  test_jvm:
    name: Execute Tests (JVM) (JDK ${{ matrix.java }})
    strategy:
      fail-fast: false
      matrix:
        java: [ 17, 21, 25 ]
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Java ${{ matrix.java }}
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: ${{ matrix.java }}
          check-latest: true

      - name: Set up sbt
        uses: sbt/setup-sbt@v1

      - name: Set up Coursier cache
        uses: coursier/cache-action@v7

      - name: Execute Unit Tests
        run: sbt --no-colors --supershell=false "version-jvm/test"

      - name: Package Project Products
        run: sbt --no-colors --supershell=false "version-jvm/package"

  test_native:
    name: Execute Tests (Native ${{ matrix.os }})
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-24.04, windows-2025, macos-26 ]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Java ${{ env.JDK_CURRENT }}
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: ${{ env.JDK_CURRENT }}
          check-latest: true

      - name: Set up sbt
        uses: sbt/setup-sbt@v1

      - name: Set up Coursier cache
        uses: coursier/cache-action@v7

      # Scala Native toolchains per OS
      - name: Install LLVM/Clang toolchain (Ubuntu)
        if: startsWith(matrix.os, 'ubuntu')
        shell: bash
        run: |
          sudo apt-get update -y
          sudo apt-get install -y clang lld llvm libuv1-dev

      - name: Install LLVM toolchain (macOS)
        if: startsWith(matrix.os, 'macos')
        shell: bash
        run: |
          brew update
          brew install llvm libuv || true
          echo "$(brew --prefix llvm)/bin" >> "$GITHUB_PATH"

      - name: Install LLVM toolchain (Windows)
        if: startsWith(matrix.os, 'windows')
        shell: pwsh
        run: |
          choco install -y llvm
          vcpkg install libuv:x64-windows
          echo "C:\Program Files\LLVM\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "$env:VCPKG_INSTALLATION_ROOT\installed\x64-windows\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "LIBRARY_PATH=$env:VCPKG_INSTALLATION_ROOT\installed\x64-windows\lib" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "C_INCLUDE_PATH=$env:VCPKG_INSTALLATION_ROOT\installed\x64-windows\include" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Execute Unit Tests
        run: sbt --no-colors --supershell=false "version-native/test"

      - name: Package Project Products
        run: sbt --no-colors --supershell=false "version-native/package"

  test_js:
    name: Execute Tests (NodeJS ${{ matrix.node }})
    strategy:
      fail-fast: false
      matrix:
        node: [ 22.x, 24.x ]
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js environment
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node }}
          check-latest: true

      - name: Setup Java ${{ env.JDK_CURRENT }}
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: ${{ env.JDK_CURRENT }}
          check-latest: true

      - name: Set up sbt
        uses: sbt/setup-sbt@v1

      - name: Set up Coursier cache
        uses: coursier/cache-action@v7

      - name: Execute Unit Tests
        run: sbt --no-colors --supershell=false "version-js/test"

      - name: Package Project Products
        run: sbt --no-colors --supershell=false "version-js/package"

  test_sbt_scripted:
    name: Execute sbt Scripted Tests
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Java ${{ env.JDK_CURRENT }}
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: ${{ env.JDK_CURRENT }}
          check-latest: true

      - name: Set up sbt
        uses: sbt/setup-sbt@v1

      - name: Set up Coursier cache
        uses: coursier/cache-action@v7

      - name: Execute sbt Scripted Tests
        run: sbt --no-colors --supershell=false "sbt-version/scripted"

  static_analysis:
    name: Static Analysis
    runs-on: ubuntu-24.04
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Java ${{ env.JDK_CURRENT }}
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: ${{ env.JDK_CURRENT }}
          check-latest: true

      - name: Set up sbt
        uses: sbt/setup-sbt@v1

      - name: Set up Coursier cache
        uses: coursier/cache-action@v7

      - name: Verify Source Formatting
        id: scalafmt
        continue-on-error: true
        run: sbt --no-colors --supershell=false scalafmtCheckAll

      - name: Verify Linting Conformity
        id: scalafix
        continue-on-error: true
        run: sbt --no-colors --supershell=false "scalafixAll --check"

      - name: Verify File Header Conformity
        id: headers
        continue-on-error: true
        run: sbt --no-colors --supershell=false headerCheckAll

      - name: Check for failures
        if: always()
        run: |
          failed=""
          [[ "${{ steps.scalafmt.outcome }}" == "failure" ]] && failed="$failed scalafmtCheckAll"
          [[ "${{ steps.scalafix.outcome }}" == "failure" ]] && failed="$failed scalafixAll"
          [[ "${{ steps.headers.outcome }}" == "failure" ]] && failed="$failed headerCheckAll"
          if [[ -n "$failed" ]]; then
            echo "::error::Static analysis checks failed:$failed"
            exit 1
          fi


  publish:
    name: Publish Release
    needs: 
      - test_jvm
      - test_native
      - test_js
      - test_sbt_scripted
      - static_analysis
    if: github.event_name != 'pull_request' && startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-24.04
    timeout-minutes: 90
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: ${{ env.JDK_RELEASE }}
          check-latest: true

      - name: Set up sbt
        uses: sbt/setup-sbt@v1

      - name: Set up Coursier cache
        uses: coursier/cache-action@v7

      - name: Import Signing Key
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.OSS_PUBLISH_USER_SIGNING_KEY }}
          git_user_signingkey: true
          git_commit_gpgsign: true
          trust_level: 5

      - name: Publish Projects
        run: sbt --no-colors --supershell=false publishSigned sonaUpload sonaRelease
        env:
          SONATYPE_USERNAME: ${{ secrets.OSS_PUBLISH_USER }}
          SONATYPE_PASSWORD: ${{ secrets.OSS_PUBLISH_USER_PASSPHRASE }}
          SIGNING_KEY_ID: ${{ secrets.OSS_PUBLISH_USER_SIGNING_KEY_ID }}

  site-release:
    name: Publish Site & GitHub Release
    needs: [ publish ]
    if: github.event_name != 'pull_request' && startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-24.04
    permissions:
      contents: write          # needed to create a release
      pages: write             # deploy to GitHub Pages
      id-token: write          # required by actions/deploy-pages
    environment:
      name: github-pages
      url: ${{ steps.deploy-pages.outputs.page_url }}
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup JDK
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: ${{ env.JDK_RELEASE }}

      - name: Setup sbt
        uses: sbt/setup-sbt@v1

      - name: Setup Coursier Cache
        uses: coursier/cache-action@v7

      - name: Build Documentation Site
        id: build-site
        run: |
          sbt -Dsbt.ci=true generateUnidoc
          site_dir="$(pwd)/target/site"
          echo "site_dir=$site_dir" >> $GITHUB_OUTPUT
          test -s "$site_dir/index.html" || { echo "::error::index.html not found or empty in $site_dir"; exit 1; }

      - name: Prepare Pages Artifact (.nojekyll)
        run: |
          touch "${{ steps.build-site.outputs.site_dir }}/.nojekyll"

      - name: Configure GitHub Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: ${{ steps.build-site.outputs.site_dir }}

      - name: Deploy to GitHub Pages
        id: deploy-pages
        uses: actions/deploy-pages@v4

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          prerelease_flag=""
          if [[ "${{ github.ref_name }}" == *-* ]]; then
            prerelease_flag="--prerelease"
          fi
          gh release create "${{ github.ref_name }}" \
            --title "${{ github.ref_name }}" \
            --generate-notes \
            --verify-tag \
            $prerelease_flag
